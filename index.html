<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ပဟီတင်ဂိမ်</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <style>
    body {
      font-family: 'Myanmar Text', sans-serif;
      background: linear-gradient(to bottom right, #e0f7fa, #80deea);
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .login-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .question {
      font-size: 20px;
      margin: 20px 0;
    }
    .options button {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #00838f;
      color: white;
      cursor: pointer;
    }
    .options button:hover {
      background-color: #006064;
    }
    .leaderboard, .online-count {
      margin-top: 30px;
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div v-if="!user" class="login-box">
      <h2>Google နော Login ဝင်ပါ</h2>
      <div id="g_id_onload"
           data-client_id="29172658075-0f08ipg8lcant46qjce04a7bb2s1higm.apps.googleusercontent.com"
           data-callback="onSignIn">
      </div>
      <div class="g_id_signin" data-type="standard"></div>
    </div>

    <div v-else>
      <h2>ကြိုဆိုပါ {{ user.name }}!</h2>
      <button @click="logout">ထောက်မား</button>

      <div v-if="cooldownLeft > 0">
        <p>တင်နာရီနားနုပေးလိုက်လုတ်ပါ။ {{ cooldownLeft }} မီနစ္စက်ကျန်ပါ။</p>
      </div>

      <div v-else>
        <div v-if="question">
          <div class="question">{{ question.text }}</div>
          <div class="options">
            <button v-for="option in question.options" @click="answer(option)">{{ option }}</button>
          </div>
          <div>ကျန္သိုအကျန်: {{ timeLeft }} seconds</div>
        </div>
        <div v-else>
          <p>အဖေမ်မန်ပါ။ နောက္တင်သတက်နင်မုတ်နီယိန်ပါ။</p>
        </div>
      </div>

      <div class="leaderboard">
        <h3>အမက္တမှား</h3>
        <p>ကိုရကောက်ကုတ်အမက္တ: {{ score }}</p>
        <ul>
          <li v-for="(entry, index) in leaderboard" :key="index">{{ entry.name }} - {{ entry.score }}</li>
        </ul>
      </div>
      <div class="online-count">
        <p>လက္ကြီ online ကစ္စတေသော့: {{ onlineCount }}</p>
      </div>
    </div>
  </div>

  <script>
    const puzzles = [...Array(100)].map((_, i) => ({
      text: `ပဟေဠိ ${i + 1}: ၁ + ${i} = ?`,
      options: [`${i + 1}`, `${i + 2}`, `${i + 3}`],
      answer: `${i + 1}`
    }));

    const app = new Vue({
      el: '#app',
      data: {
        user: null,
        question: null,
        score: 0,
        mistakes: 0,
        cooldownStart: null,
        timeLeft: 30,
        timer: null,
        onlineCount: Math.floor(Math.random() * 1000) + 1,
        leaderboard: []
      },
      computed: {
        cooldownLeft() {
          if (!this.cooldownStart) return 0;
          const now = new Date();
          const diff = 60 - Math.floor((now - new Date(this.cooldownStart)) / 60000);
          return diff > 0 ? diff : 0;
        }
      },
      methods: {
        loadFromStorage() {
          const data = JSON.parse(localStorage.getItem('puzzleData')) || {};
          if (data[this.user.email]) {
            const userData = data[this.user.email];
            this.score = userData.score || 0;
            this.cooldownStart = userData.cooldownStart || null;
          }
        },
        saveToStorage() {
          const allData = JSON.parse(localStorage.getItem('puzzleData')) || {};
          allData[this.user.email] = {
            score: this.score,
            cooldownStart: this.cooldownStart
          };
          localStorage.setItem('puzzleData', JSON.stringify(allData));
        },
        logout() {
          this.user = null;
          this.score = 0;
          clearInterval(this.timer);
        },
        startGame() {
          if (this.cooldownLeft > 0) return;
          this.question = puzzles[Math.floor(Math.random() * puzzles.length)];
          this.timeLeft = 30;
          clearInterval(this.timer);
          this.timer = setInterval(() => {
            this.timeLeft--;
            if (this.timeLeft <= 0) {
              this.mistakes++;
              this.checkMistakes();
            }
          }, 1000);
        },
        answer(option) {
          if (option === this.question.answer) {
            this.score++;
            this.updateLeaderboard();
            this.question = null;
            setTimeout(() => this.startGame(), 1000);
          } else {
            this.mistakes++;
            this.checkMistakes();
          }
          this.saveToStorage();
        },
        checkMistakes() {
          if (this.mistakes >= 3) {
            this.cooldownStart = new Date().toISOString();
            this.question = null;
            this.saveToStorage();
          } else {
            this.question = null;
            setTimeout(() => this.startGame(), 1000);
          }
        },
        updateLeaderboard() {
          const entry = { name: this.user.name, score: this.score };
          this.leaderboard = this.leaderboard.filter(e => e.name !== entry.name);
          this.leaderboard.push(entry);
          this.leaderboard.sort((a, b) => b.score - a.score);
          if (this.leaderboard.length > 10) this.leaderboard.length = 10;
        }
      },
      mounted() {
        const rawUser = localStorage.getItem('puzzleUser');
        if (rawUser) {
          this.user = JSON.parse(rawUser);
          this.loadFromStorage();
          this.startGame();
        }
      }
    });

    function onSignIn(response) {
      const user = jwt_decode(response.credential);
      app.user = { name: user.name, email: user.email };
      localStorage.setItem('puzzleUser', JSON.stringify(app.user));
      app.loadFromStorage();
      app.startGame();
    }
  </script>
</body>
</html>
